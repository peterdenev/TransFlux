!function(e,n){"function"==typeof define&&define.amd?define("TransFlux",["emitterImpl"],n):"object"==typeof exports?module.exports=n(emitterImpl):e.TransFlux=n(emitterImpl)}(this,function(e){function n(){"function"!=typeof e.emitToMany&&(e.emitToMany=function(n,t){for(var o in n)e.emit(n[o],t)})}function t(e){var n={data:{},funcs:{}};for(var t in e)"function"==typeof e[t]?n.funcs[t]=e[t]:n.data[t]=e[t];return n}function o(e,n,t){if(t="undefined"!=typeof t?t:!1,0==n.length)return!1;if(-1!=n.indexOf(e))return!0;if(-1!=n.indexOf("*"))return!0;if("*"==e)return!0;for(var o in n){if(!t&&0===n[o].indexOf(e))return!0;if(0===e.indexOf(n[o]))return!0}return!1}function r(e){var n=!1,t=!1,o=function(r){!n||r?(n=!0,e(),t&&(t=!1,o(!0)),n=!1):t=!0};return o}if(!e)throw"Need to set an eventemitter implementation for - emitterImpl";n();var a={evSep:"."},i=function(n,t,r,i){for(var c in r)this[c]=r[c];var s={};this.get=function(e){return ObjectHelper.getNested(t,e)},this.set=function(e,n){if(!o(e,i.func_locks,!0))throw'TransFlux: Try to set a value to not self-locked key_path "'+e+'" from func "'+i.func_name+'" ';ObjectHelper.checkNested(t,e)?ObjectHelper.setNested(t,e,n)?s[e]=n:console.warn("TransFlux","Failed to set a value to key path",[e,n]):console.warn("TransFlux","Someone try to set a value to not existing key path!",[e,n])},this.setChanged=function(e){if(ObjectHelper.checkNested(t,e)){var n=ObjectHelper.getNested(t,e);"object"!=typeof n&&console.warn("TransFlux",'Use setChanged only for array or object, or use "set" insted!'),s[e]=n}else console.warn("TransFlux","Someone try to setChange to not existing key path!",e)},this.use=function(e,n){this.set(e,n.apply(this,[this.get(e)]))},this.emitCommit=function(){var t={changes:s,origin_event:i};e.emit(n+a.evSep+"commit",t),e.emit(i.full_name+a.evSep+"commit",t)},this.emitRollback=function(t){var o={reason:t,origin_event:i,status:"rollbacked"};e.emitToMany([n+a.evSep+"done",n+a.evSep+"rollbacked",i.full_name+a.evSep+"done",i.full_name+a.evSep+"rollbacked",n+a.evSep+"_readyForNext"],o)}},c=function(n,t){function o(t){for(var o in t.changes)ObjectHelper.setNested(i,o,t.changes[o]);p();var r={state:f(),changes:t.changes,status:"updated",origin_event:t.origin_event};e.emitToMany([n+a.evSep+"done",n+a.evSep+"updated",t.origin_event.full_name+a.evSep+"done",t.origin_event.full_name+a.evSep+"updated",n+a.evSep+"_readyForNext"],r)}var i=$.extend(!0,{},t);i._stateVersion=-1;var c=function(){return i._stateVersion},s=null,u=null,f=function(){return u},l=function(){return $.extend(!0,{},s)},p=function(){i._stateVersion++,s=$.extend(!0,{},i),u=ObjectHelper.deepFreeze($.extend(!0,{},i))},v=[];e.on(n+a.evSep+"commit",function(e){v.push({data:e,event:{name:n+a.evSep+"commit",store_prefix:n}}),m()});var m=r(function(){for(var e=0;e<v.length;e++)o(v[e].data),v.splice(e,1),e--});return p(),{getReadOnlyState:f,getLastStableState:l,getLastVersionNum:c}},s=function(n,s){function u(e){var n=_.data.actionsMap[e],t=n,o=["*"];return"object"==typeof n&&(n.hasOwnProperty("func")&&(t=n.func),n.hasOwnProperty("locks")&&(o=n.locks)),{func_name:t,func_locks:o}}function f(t,o,r){var i=n+a.evSep+t;e.on(i,function(){var e=Array.prototype.slice.call(arguments);d.push({func_name:o,func_locks:r,args:e,event:{name:t,full_name:i,func_name:o,func_locks:r}}),g()})}function l(e){setTimeout(function(){p(e.func_name,e.args,e.event,e.func_locks)},0)}function p(e,t,o){var r=new i(n,h.getLastStableState(),_.funcs,o);try{r[e].apply(r,t)}catch(a){console.error("TransFlux",'Action exception in function "'+e+'"',a),r.emitRollback(a)}}function v(e){var n=u(e.origin_event.name);for(var t in n.func_locks){var o=m.indexOf(n.func_locks[t]);-1!=o&&m.splice(o,1)}g()}var m=[],d=[],_=t(s),h=c(n,_.data),g=r(function(){for(var e=0;e<d.length;e++){var n=d[e],t=!0;for(var r in n.func_locks)if(o(n.func_locks[r],m)){t=!1;break}t&&(m=m.concat(n.func_locks),d.splice(e,1),e--,l(n))}});if(e.on(n+a.evSep+"_readyForNext",v),_.data.hasOwnProperty("actionsMap"))for(var y in _.data.actionsMap){var x=u(y);_.funcs.hasOwnProperty(x.func_name)?f(y,x.func_name,x.func_locks):console.warn("TransFlux",'Action method "'+x.func_name+'" not found for store "'+n+'"')}else console.warn("TransFlux",'No actionsMap for store with prefix "'+n+'"');return{getState:h.getReadOnlyState,getLastVersionNum:h.getLastVersionNum}};return{options:a,StoreCreator:s}});