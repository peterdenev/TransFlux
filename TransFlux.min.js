function _tryEnqueueShell(e){var t=!1,n=!1,a=function(r){!t||r?(t=!0,e(),n&&(n=!1,a(!0)),t=!1):n=!0};return a}function extractFuncAndData(e){var t={data:{},funcs:{}};for(var n in e)"function"==typeof e[n]?t.funcs[n]=e[n]:t.data[n]=e[n];return t}if(!emitterImpl)throw"Need to set an eventemitter implementation for - emitterImpl";"function"!=typeof emitterImpl.emitToMany&&(emitterImpl.emitToMany=function(e,t){for(var n in e)emitterImpl.emit(e[n],t)});var event_name_separator="undefined"!=typeof event_name_separator?event_name_separator:".",TransactStore=function(e,t,n,a){for(var r in n)this[r]=n[r];var o={};this.get=function(e){return ObjectHelper.getNested(t,e)},this.set=function(e,n){ObjectHelper.checkNested(t,e)?ObjectHelper.setNested(t,e,n)?o[e]=n:console.warn("TransFlux","Failed to set a value to key path",[e,n]):console.warn("TransFlux","Someone try to set a value to not existing key path!",[e,n])},this.setChanged=function(e){if(ObjectHelper.checkNested(t,e)){var n=ObjectHelper.getNested(t,e);"object"!=typeof n&&console.warn("TransFlux",'Use setChanged only for array or object, or use "set" insted!'),o[e]=n}else console.warn("TransFlux","Someone try to setChange to not existing key path!",e)},this.use=function(e,t){this.set(e,t.apply(this,[this.get(e)]))},this.emitCommit=function(){var t={changes:o,origin_event_name:a};emitterImpl.emit(e+"commit",t),emitterImpl.emit(a+event_name_separator+"commit",t)},this.emitRollback=function(t){var n={reason:t,origin_event_name:a,status:"rollbacked"};emitterImpl.emitToMany([e+"done",e+"rollbacked",a+event_name_separator+"done",a+event_name_separator+"rollbacked",e+"_readyForNext"],n)}},StateManager=function(e,t){function n(t){for(var n in t.changes)ObjectHelper.setNested(a,n,t.changes[n]);u();var r={state:s(),changes:t.changes,status:"updated",origin_event_name:t.origin_event_name};emitterImpl.emitToMany([e+"done",e+"updated",t.origin_event_name+event_name_separator+"done",t.origin_event_name+event_name_separator+"updated",e+"_readyForNext"],r)}var a=$.extend(!0,{},t);a._stateVersion=-1;var r=function(){return a._stateVersion},o=null,i=null,s=function(){return i},c=function(){return $.extend(!0,{},o)},u=function(){a._stateVersion++,o=$.extend(!0,{},a),i=ObjectHelper.deepFreeze($.extend(!0,{},a))},f=[];emitterImpl.on(e+"commit",function(t){f.push({data:t,event:{name:e+"commit",store_prefix:e}}),l()});var l=_tryEnqueueShell(function(){for(var e=0;e<f.length;e++)n(f[e].data),f.splice(e,1),e--});return u(),{getReadOnlyState:s,getLastStableState:c,getLastVersionNum:r}},StoreCreator=function(e,t){function n(e,t,n){emitterImpl.on(e,function(){var a=Array.prototype.slice.call(arguments);u.push({func_name:t,func_locks:n,args:a,event:{name:e}}),m()})}function a(e){setTimeout(function(){o(e.func_name,e.args,e.event.name,e.func_locks)},0)}function r(t){var n=t.origin_event_name.substr((e+".").length-1),a=i(n);for(var r in a.func_locks){var o=c.indexOf(a.func_locks[r]);-1!=o&&c.splice(o,1)}m()}function o(t,n,a){var r=new TransactStore(e,l.getLastStableState(),f.funcs,a);try{r[t].apply(r,n)}catch(o){console.error("TransFlux",'Action exception in function "'+t+'"',o),r.emitRollback(o)}}function i(e){var t=f.data.actionsMap[e],n=t,a=["*"];return"object"==typeof t&&(t.hasOwnProperty("func")&&(n=t.func),t.hasOwnProperty("locks")&&(a=t.locks)),{func_name:n,func_locks:a}}function s(e){if(-1!=c.indexOf(e))return!0;for(var t in c)if(0===c[t].indexOf(e)||0===e.indexOf(c[t]))return!0;return!1}var c=[],u=[],f=extractFuncAndData(t),l=StateManager(e,f.data),m=_tryEnqueueShell(function(){for(var e=0;e<u.length;e++){var t=u[e],n=!0;for(var r in t.func_locks)if(s(t.func_locks[r])){n=!1;break}n&&(c=c.concat(t.func_locks),u.splice(e,1),e--,a(t))}});if(emitterImpl.on(e+"_readyForNext",r),f.data.hasOwnProperty("actionsMap"))for(var p in f.data.actionsMap){var _=i(p);f.funcs.hasOwnProperty(_.func_name)?n(e+p,_.func_name,_.func_locks):console.warn("TransFlux",'Action method "'+_.func_name+'" not found for store "'+e+'"')}else console.warn("TransFlux",'No actionsMap for store with prefix "'+e+'"');return{getState:l.getReadOnlyState,getLastVersionNum:l.getLastVersionNum}};